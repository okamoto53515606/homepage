# 2025/12/28 @FirebaseStudio

# AIへの指示
まだプログラム修正は不要です。
一度にすべてを開発せず、少しづつ、順番に開発していきます。
まずは、Googleログイン連携(Firebase Auth)を開発します。
bluprint.mdのロール設計に以下を追加しました。コメントやstripe決済の前にGoogleログインが必要です。
    1.  **ゲスト:** 未ログイン。無料記事のみ閲覧可。コメント不可。
    2.  **無料会員:** ログイン済み。有料アクセス権なし。コメント可能。
    3.  **有料会員:** ログイン済み。`users` コレクションの `access_expiry` が現在時刻より未来であること。
    4.  **管理者:** Firebase AuthのCustom Claimsに `{ admin: true }` を付与されたユーザー。全ての記事を閲覧可能。
bluprint.mdの内容を理解した上で、開発に協力いただけますか？

# gemini の 回答
はい、承知いたしました。docs/blueprint.md のロール設計に追記された内容を反映し、今後の開発でGoogleログイン連携から進めていくことを理解しました。

# AIへの指示
bluprint.mdに記載の通り、あなた(AI)の方でGoogleログインの実装方法を提案いただくことは可能ですか？

# gemini の 回答
はい、もちろんです。blueprint.mdの要件に基づき、Firebase Authenticationを使用したGoogleログイン機能の実装を提案します。

まず、Firebase SDKを初期化し、認証状態を管理するための設定を行います。次に、ヘッダーのUIを更新し、実際のGoogleログイン・ログアウト機能を追加します。

以下のファイル変更で、Googleログインを実装します。
9ab860c
+5 more files
これらの変更を適用すると、Googleログイン機能が実装されます。

重要: 適用後、.envファイルに実際のFirebaseプロジェクト設定値を入力してください。これらの値はFirebaseコンソールのプロジェクト設定ページで確認できます。

準備ができたら、次のステップに進みましょう。

# AIへの指示
Firebaseコンソールの設定手順の説明をお願いできますか？

# gemini の 回答
はい、承知いたしました。Firebaseコンソールでの設定手順をご説明します。

コードの変更はありませんので、以下の手順に従って設定を進めてください。

FirebaseコンソールにGoogleアカウントでログインします。
「プロジェクトを追加」をクリックし、画面の指示に従って新しいプロジェクトを作成します。（プロジェクト名は homepage など、わかりやすいものが良いでしょう。）
Googleアナリティクスは、このプロトタイプでは無効（「このプロジェクトで Google アナリティクスを有効にする」のチェックを外す）で構いません。
作成したプロジェクトのダッシュボード（概要ページ）で、ウェブアイコン（ </> ）をクリックします。
「アプリの登録」画面が表示されます。
アプリのニックネーム: homepage-prototype など、任意の名前を入力します。
「このアプリのFirebase Hostingも設定します」のチェックは外してください。
「アプリを登録」をクリックします。
「Firebase SDK を追加」の画面に進みます。「npm を使用」が選択されていることを確認し、firebaseConfig というオブジェクトが表示されているのを確認してください。
この firebaseConfig オブジェクトの中に、apiKey, authDomain などのキーと値が含まれています。
取得したキーを、プロジェクトの .env ファイルにコピー＆ペーストします。NEXT_PUBLIC_ というプレフィックスを各変数名の前に追加してください。

例:

NEXT_PUBLIC_FIREBASE_API_KEY="your-api-key-from-firebase"
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN="your-auth-domain-from-firebase"
NEXT_PUBLIC_FIREBASE_PROJECT_ID="your-project-id-from-firebase"
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET="your-storage-bucket-from-firebase"
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID="your-messaging-sender-id-from-firebase"
NEXT_PUBLIC_FIREBASE_APP_ID="your-app-id-from-firebase"

Firebaseコンソールの左側のメニューから「Authentication」を選択します。
「Sign-in method」タブをクリックします。
プロバイダの一覧から「Google」を選択します。
右上の「有効にする」のトグルスイッチをオンにします。
プロジェクトのサポートメールを選択します。（通常はご自身のメールアドレスが選択肢に表示されます。）
「保存」をクリックします。
blueprint.md にある「管理者」ロールをテストするために、特定のユーザーに管理者権限を付与する手順です。

まず、ご自身のGoogleアカウントで一度、開発中のアプリにログインします。

Firebaseコンソールの Authentication > Users タブに、ログインしたご自身のアカウントが表示されます。その行の右端にあるメニュー（︙）から「ユーザーUIDをコピー」を選択します。

Firebase StudioのGenkitは、現時点ではカスタムクレームを直接設定する機能を提供していません。この設定は通常、Firebase Admin SDKを使ってサーバーサイドで行います。

将来的にはGenkitのフローでこの操作を実装することも考えられますが、プロトタイプの現段階では、「テスト用のadminロールはCookieで設定する」 という既存の仕組みをそのまま利用するのが最も簡単です。

ヘッダーに表示されている通り、ブラウザの開発者ツールで user_role という名前のCookieを作成し、値を admin に設定することで管理者として動作します。

以上の設定が完了すれば、Googleログインが機能するようになります。 ご不明な点があれば、お気軽にご質問ください。

# AIへの指示
ありがとう。blueprint.mdに記載の通り、管理者はFirebase AuthのCustom Claimsに `{ admin: true }` を付与されたユーザーとしたいです。本件はプロトタイプですが、商用利用はします。プログラムはまだ修正せず、あなたの理解だけ回答願います。
#### A. 管理者（運営者＝あなた）
*   **実装:** Firebase Authの **「カスタムクレーム (Custom Claims)」** を使うのが最も安全です。
*   **方法:** 開発用スクリプト（Node.jsなど）で、あなたのUIDに対して一度だけ `{ admin: true }` という属性を付与します。
*   **理由:** フロントエンドのJSで改ざんできないため、管理画面へのアクセス制限に最適です。

#### B. 有料会員（N日間見放題）
*   **実装:** **Firestoreのユーザー・ドキュメント** で管理します。
*   **データ構造例:** `user_doc = { paid_until: "2025-12-31T23:59:59" }`
*   **判定:** 記事にアクセスした際、`現在時刻 < paid_until` かどうかをチェック。
*   **理由:** 有効期限はStripeの決済に応じて頻繁に書き換わるため、静的なカスタムクレームよりDB管理の方が柔軟です。Firestoreのセキュリティルールでも `request.time < resource.data.paid_until` のように判定に使えます。

#### C. 無料会員（ログイン済み）
*   **判定:** `firebase.auth().currentUser` が存在するかどうかだけで判定。

#### D. ゲスト（未ログイン）
*   **判定:** `currentUser` が `null`。

# gemini の 回答
はい、承知いたしました。 ロール（権限）管理に関する詳細なご説明ありがとうございます。プログラムの修正は行わず、私の理解をご回答します。

以下の設計方針を理解しました。

管理者 (Admin):

Firebase Authenticationのカスタムクレームに { admin: true } が設定されているユーザー。
この方法はフロントエンドで改ざんできず、極めて安全な管理者権限の実装方法です。
有料会員 (Paid Member):

Firestoreの各ユーザードキュメントに paid_untilのような有効期限を示すタイムスタンプを保存。
コンテンツへのアクセス時に、現在時刻がこの paid_until 以前であるかを確認して判定します。Stripe決済と連携しやすく、柔軟な期限管理に適しています。
無料会員 (Free Member):

Googleログイン済み（currentUser が存在する）だが、「管理者」でも「有料会員」でもないユーザー。
ゲスト (Guest):

ログインしていない（currentUser が null の）ユーザー。
この役割分担のロジックは、セキュアでスケーラブルなアプリケーションを構築するためのベストプラクティスに沿っており、非常に明確です。

今後の開発では、この設計方針に従って実装を進めます。 準備ができましたら、次のステップをお知らせください。


